services:
  # --- Single OpenClaw instance (research bot) ---
  openclaw-research:
    build:
      context: .
      dockerfile: Dockerfile.openclaw
    environment:
      - OPENCLAW_PROFILE=research-bot
      - OPENCLAW_PORT=18790
      - OPENCLAW_GATEWAY_TOKEN=${OPENCLAW_TOKEN}
      - ALLOWED_ORIGIN=${EXTERNAL_URL:-http://localhost:8422}
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY:-sk-ant-placeholder}
    restart: unless-stopped

  # --- OpenClaw Studio (production build) ---
  studio:
    build:
      context: .
      dockerfile: Dockerfile.studio
    environment:
      - GATEWAY_WS_URL=${GATEWAY_WS_URL:-ws://localhost:8422/api/gateway/ws}
    restart: unless-stopped

  # --- ClawGateway (auth + routing) ---
  gateway:
    build:
      context: .
      dockerfile: Dockerfile
    ports:
      - "${GATEWAY_PORT:-8422}:8422"
    environment:
      - PORT=8422
      - GATEWAY_CONFIG={"port":8422,"sessionSecret":"${SESSION_SECRET}","mode":"marketplace","studioUpstream":"http://studio:3000","devMode":true,"devUser":{"email":"dev@test.local","profile":"research-bot"},"auth":[{"provider":"twitter","clientId":"${AUTH_CLIENT_ID:-placeholder}","clientSecret":"${AUTH_CLIENT_SECRET:-placeholder}"}],"profiles":{"research-bot":{"upstream":"http://openclaw-research:18790","token":"${OPENCLAW_TOKEN}","description":"AI Research Assistant","default":true}}}
    depends_on:
      - openclaw-research
      - studio
    restart: unless-stopped
